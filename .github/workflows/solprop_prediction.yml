name: SolProp ML Prediction (Real)

on:
  workflow_dispatch:
  push:
    paths:
      - 'input/**'

jobs:
  predict:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Conda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: 3.8
        channels: conda-forge,defaults
        channel-priority: flexible
        
    - name: Install RDKit and dependencies
      shell: bash -l {0}
      run: |
        conda install -c conda-forge rdkit numpy pandas scikit-learn scipy -y
        
    - name: Install descriptastorus
      shell: bash -l {0}
      run: |
        pip install git+https://github.com/bp-kelley/descriptastorus
        
    - name: Clone and install SolProp_ML
      shell: bash -l {0}
      run: |
        git clone https://github.com/fhvermei/SolProp_ML.git
        cd SolProp_ML
        pip install -e .
        
    - name: Download ML models
      shell: bash -l {0}
      run: |
        # Download models using Dropbox direct download URL
        curl -L -o models.zip "https://dl.dropboxusercontent.com/s/p6p39e2gfbdmuqj/Machine_learning_models.zip"
        
        # Verify the download is a valid zip file
        file models.zip
        if ! file models.zip | grep -q "Zip archive"; then
          echo "Error: Downloaded file is not a valid zip archive"
          echo "File contents:"
          head -n 20 models.zip
          exit 1
        fi
        
        # Extract the zip file
        unzip models.zip
        
        # Copy models to the correct location
        mkdir -p SolProp_ML/solvation_predictor/trained_models/
        cp -r Machine_learning_models/Gsolv SolProp_ML/solvation_predictor/trained_models/
        cp -r Machine_learning_models/Hsolv SolProp_ML/solvation_predictor/trained_models/
        cp -r Machine_learning_models/Saq SolProp_ML/solvation_predictor/trained_models/
        
        echo "Models installed successfully"
        ls -la SolProp_ML/solvation_predictor/trained_models/
        
    - name: Verify installation
      shell: bash -l {0}
      run: |
        cd SolProp_ML
        python -c "from solvation_predictor import calculate_solubility, predict_property; print('âœ“ SolProp_ML imported successfully')"
        
    - name: Create output directory
      run: mkdir -p output
        
    - name: Run predictions
      shell: bash -l {0}
      run: |
        export PYTHONPATH="${PYTHONPATH}:${PWD}/SolProp_ML"
        python scripts/run_prediction_real.py
        
    - name: List output files
      run: |
        echo "=== Generated output files ==="
        ls -lh output/
        
    - name: Upload results as artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: solprop-results-${{ github.run_number }}
        path: output/
        retention-days: 30
        
    - name: Commit and push results
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git pull origin ${{ github.ref_name }} --rebase
        git add output/
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Add SolProp prediction results [run #${{ github.run_number }}]"
          git push
        fi
